import{r as R,g as N}from"./maplibre-BbqsL0sN.js";import{J as v,X as I,A as T,f as $}from"./duckdb-CXkSyTZP.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))e(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&e(o)}).observe(document,{childList:!0,subtree:!0});function i(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerPolicy&&(s.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?s.credentials="include":a.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function e(a){if(a.ep)return;a.ep=!0;const s=i(a);fetch(a.href,s)}})();var D=R();const _=N(D);class M{constructor(){this.db=null,this.conn=null,this.initialized=!1}async init(){try{const t=v(),i=await I(t),e=URL.createObjectURL(new Blob([`importScripts("${i.mainWorker}");`],{type:"text/javascript"})),a=new Worker(e),s=new T;this.db=new $(s,a),await this.db.instantiate(i.mainModule,i.pthreadWorker),this.conn=await this.db.connect(),this.initialized=!0,console.info("DuckDB-WASM initialized successfully")}catch(t){throw console.error("Failed to initialize DuckDB:",t),new Error(`DuckDB initialization failed: ${t.message}`)}}async loadParquetFiles(t,i){if(!this.initialized)throw new Error("DuckDB not initialized");const a=`${typeof window<"u"?window.location.origin:""}${t.startsWith("/")?"":"/"}${t}`;try{for(const[s,o]of Object.entries(i)){const n=`${a}/${o}?v=${Date.now()}`,r=`${a}/${o.replace(".parquet",".json")}?v=${Date.now()}`;let c=!1;try{await this.conn.query(`
            CREATE OR REPLACE VIEW ${s} AS 
            SELECT * FROM read_parquet('${n}')
          `),console.info(`Loaded ${s} from Parquet: ${n}`),c=!0}catch{console.warn(`Parquet load failed for ${s}, trying JSON...`)}if(!c)try{await this.conn.query(`
              CREATE OR REPLACE VIEW ${s} AS 
              SELECT * FROM read_json_auto('${r}')
            `),console.info(`Loaded ${s} from JSON: ${r}`)}catch(l){throw new Error(`Failed to load ${s}: ${l.message}`)}}}catch(s){throw console.error("Failed to load data files:",s),new Error(`Failed to load data: ${s.message}`)}}async getAllStations(){const t=await this.conn.query(`
      SELECT 
        station_id,
        common_name,
        lat,
        lon,
        zone,
        modes
      FROM stations
      ORDER BY common_name
    `);return this.arrowToArray(t)}async getStation(t){const i=await this.conn.query(`
      SELECT 
        station_id,
        common_name,
        lat,
        lon,
        zone,
        modes
      FROM stations
      WHERE station_id = '${this.escape(t)}'
      LIMIT 1
    `),e=this.arrowToArray(i);return e.length>0?e[0]:null}async getAllConnections(){const t=await this.conn.query(`
      SELECT 
        c.source_station_id,
        c.target_station_id,
        c.line_id,
        c.line_name,
        c.line_mode,
        c.haversine_distance_km,
        c.coordinates
      FROM connections c
    `),i=this.arrowToArray(t);return i.forEach((e,a)=>{let s=e.coordinates;if(typeof s=="string")try{let o=JSON.parse(s);typeof o=="string"&&(o=JSON.parse(o)),e.coordinates=o}catch(o){console.warn(`[DuckDB] Failed to parse coordinates for connection ${a}:`,o),e.coordinates=null}}),i}async getFaresFromOrigin(t,i="cheapest",e="offpeak",a=1500){const s=e==="peak"?"payg_peak_pence":"payg_offpeak_pence";let o;switch(i){case"default":o=`r.is_default DESC, f.${s} ASC`;break;case"cheapest":default:o=`f.${s} ASC`}const n=await this.conn.query(`
      WITH ranked_fares AS (
        SELECT 
          f.dest_id,
          f.${s} as fare,
          s.common_name,
          s.lat,
          s.lon,
          s.zone,
          ROW_NUMBER() OVER (
            PARTITION BY f.dest_id 
            ORDER BY ${o}
          ) as rn
        FROM fares f
        JOIN stations s ON f.dest_id = s.station_id
        LEFT JOIN routes r ON f.route_id = r.route_id
        WHERE f.origin_id = '${this.escape(t)}'
          AND f.${s} <= ${a}
      )
      SELECT * FROM ranked_fares
      WHERE rn = 1
      ORDER BY fare ASC
    `);return this.arrowToArray(n)}async getLinesAtStation(t){const i=await this.conn.query(`
      SELECT DISTINCT line_name
      FROM connections
      WHERE source_station_id = '${this.escape(t)}'
         OR target_station_id = '${this.escape(t)}'
    `);return this.arrowToArray(i).map(a=>a.line_name)}async getStationsOnLines(t){if(!t||t.length===0)return new Set;const i=t.map(s=>`'${this.escape(s)}'`).join(","),e=await this.conn.query(`
      SELECT DISTINCT source_station_id as id
      FROM connections
      WHERE line_name IN (${i})
      UNION
      SELECT DISTINCT target_station_id as id
      FROM connections
      WHERE line_name IN (${i})
    `),a=this.arrowToArray(e);return new Set(a.map(s=>s.id))}async getConnectionsOnLines(t){if(!t||t.length===0)return[];const i=t.map(a=>`'${this.escape(a)}'`).join(","),e=await this.conn.query(`
      SELECT DISTINCT
        c.source_station_id,
        c.target_station_id,
        lower(c.line_name) as line_name,
        s1.lat as source_lat,
        s1.lon as source_lon,
        s2.lat as target_lat,
        s2.lon as target_lon
      FROM connections c
      JOIN stations s1 ON c.source_station_id = s1.station_id
      JOIN stations s2 ON c.target_station_id = s2.station_id
      WHERE c.line_name IN (${i})
    `);return this.arrowToArray(e)}async getRouteGeometry(t){if(!t||t.length===0)return{type:"FeatureCollection",features:[]};const i=t.map(o=>`'${this.escape(o)}'`).join(","),e=await this.conn.query(`
      SELECT DISTINCT
        c.line_id,
        c.line_name,
        c.branch_name as branch_index,
        c.coordinates,
        s1.lat as source_lat,
        s1.lon as source_lon,
        s2.lat as target_lat,
        s2.lon as target_lon
      FROM connections c
      JOIN stations s1 ON c.source_station_id = s1.station_id
      JOIN stations s2 ON c.target_station_id = s2.station_id
      WHERE c.line_name IN (${i})
    `);return{type:"FeatureCollection",features:this.arrowToArray(e).map(o=>{let n=[];if(Array.isArray(o.coordinates))n=o.coordinates;else try{typeof o.coordinates=="string"&&(n=JSON.parse(o.coordinates),typeof n=="string"&&(n=JSON.parse(n)))}catch(l){console.warn(`Failed to parse route geometry for ${o.line_id}:`,l)}let r="LineString";const c=l=>Array.isArray(l)||l&&typeof l=="object"&&typeof l.length=="number";return n.length>0&&c(n[0])&&c(n[0][0])&&(r="MultiLineString"),{type:"Feature",geometry:{type:r,coordinates:n},properties:{line_id:o.line_id,line_name:o.line_name,branch_index:o.branch_index}}})}}async getRouteOptions(t,i,e="offpeak"){const a=e==="peak"?"payg_peak_pence":"payg_offpeak_pence",s=await this.conn.query(`
      SELECT 
        f.route_id,
        r.description,
        r.validator_info,
        r.is_default,

        f.${a} as fare_pence,
        f.passenger_type
      FROM fares f
      JOIN routes r ON f.route_id = r.route_id
      WHERE f.origin_id = '${this.escape(t)}'
        AND f.dest_id = '${this.escape(i)}'
      ORDER BY 
        r.is_default DESC,
        f.${a} ASC
    `);return this.arrowToArray(s)}async getFareSummary(t,i){const e=await this.conn.query(`
      SELECT 
        MIN(payg_offpeak_pence) as cheapest_offpeak,
        MIN(payg_peak_pence) as cheapest_peak,
        
        -- Default route fare (takes the minimum if multiple default routes exist, though usually one)
        MIN(CASE WHEN r.is_default THEN payg_offpeak_pence END) as default_fare_offpeak,
        MIN(CASE WHEN r.is_default THEN payg_peak_pence END) as default_fare_peak
      FROM fares f
      LEFT JOIN routes r ON f.route_id = r.route_id
      WHERE f.origin_id = '${this.escape(t)}'
        AND f.dest_id = '${this.escape(i)}'
    `),a=this.arrowToArray(e);return a.length>0?a[0]:null}async getRouteConnections(t){const i=await this.conn.query(`
      SELECT 
        c.source_station_id,
        c.source_station_id,
        c.target_station_id,
        c.line_id,
        c.line_mode,
        c.line_name,
        c.coordinates,
        s1.lat as source_lat,
        s1.lon as source_lon,
        s2.lat as target_lat,
        s2.lon as target_lon
      FROM connections c
      JOIN stations s1 ON c.source_station_id = s1.station_id
      JOIN stations s2 ON c.target_station_id = s2.station_id
      -- Note: In a real implementation we would filter by route_id
      -- For this demo, we might need to pass a specific station list or just trust the pathfinder
      WHERE 1=0 -- Still disabled until we have route_id back in connections for precise selection
      -- OR we change this to take a list of (start, end) pairs?
    `),e=this.arrowToArray(i);return e.forEach((a,s)=>{let o=a.coordinates;if(typeof o=="string")try{o=JSON.parse(o),typeof o=="string"&&(o=JSON.parse(o)),a.coordinates=o}catch(n){console.warn(`[DuckDB] Failed to parse coordinates for connection ${s}:`,n)}}),e}async getStats(){var s,o;const t=await this.conn.query("SELECT COUNT(*) as count FROM stations"),i=await this.conn.query("SELECT COUNT(*) as count FROM fares"),e=this.arrowToArray(t),a=this.arrowToArray(i);return{stationCount:((s=e[0])==null?void 0:s.count)||0,fareCount:((o=a[0])==null?void 0:o.count)||0}}arrowToArray(t){const i=[],e=t.schema.fields.map(s=>s.name),a=s=>s==null?s:typeof s=="bigint"?Number(s):(s&&typeof s.toJSON=="function"&&(s=s.toJSON()),Array.isArray(s)?s.map(a):ArrayBuffer.isView(s)?Array.from(s):s);for(const s of t.batches)for(let o=0;o<s.numRows;o++){const n={};for(const r of e){let c=s.getChildAt(e.indexOf(r)).get(o);n[r]=a(c)}i.push(n)}return i}escape(t){return String(t).replace(/'/g,"''")}async close(){this.conn&&await this.conn.close(),this.db&&await this.db.terminate(),this.initialized=!1}}const A={bakerloo:"#B36305",central:"#E32017",circle:"#FFD300",district:"#00782A","hammersmith-city":"#F3A9BB",jubilee:"#A0A5A9",metropolitan:"#9B0056",northern:"#000000",piccadilly:"#003688",victoria:"#0098D4","waterloo-city":"#95CDBA",dlr:"#00A4A7",elizabeth:"#6950a1","elizabeth-line":"#6950a1",tram:"#84B817",liberty:"#7C878E",lioness:"#FDB913",mildmay:"#0056A3",suffragette:"#00853E",weaver:"#7B4391",windrush:"#E02636","london-overground":"#EE7C0E",overground:"#EE7C0E",c2c:"#b7007c","chiltern-railways":"#00bfff","east-midlands-railway":"#713563","greater-anglia":"#d70428","great-western-railway":"#0a493e","heathrow-express":"#532e63","london-north-eastern-railway":"#ce0e2d",southeastern:"#389cff",southern:"#8cc63e","south-western-railway":"#24398c",thameslink:"#ff5aa4","west-midlands-trains":"#ff8300","avanti-west-coast":"#004354",default:"#888888"},d=["#22c55e","#55a558","#898551","#a2744e","#af6c4c","#bc644b","#c85c49","#d55447","#ef4444"],C=[[290,d[0]],[350,d[1]],[380,d[2]],[460,d[3]],[520,d[4]],[580,d[5]],[670,d[6]],[820,d[7]],[830,d[8]]],b=[[280,d[0]],[290,d[1]],[310,d[2]],[340,d[3]],[360,d[4]],[380,d[5]],[490,d[6]],[491,d[7]],[500,d[8]]];class k{constructor(t,i){this.containerId=t,this.config=i,this.map=null,this.eventHandlers={},this.stationsById={},this.originId=null,this.destinationId=null,this.hoverTimeout=null}async init(){return new Promise((t,i)=>{try{this.map=new _.Map({container:this.containerId,style:this.config.style,center:this.config.center,zoom:this.config.zoom,minZoom:this.config.minZoom,maxZoom:this.config.maxZoom,attributionControl:!0}),this.map.addControl(new _.NavigationControl({showCompass:!1}),"top-right"),this.map.on("load",()=>{this.setupLayers(),t()}),this.map.on("error",e=>{i(e.error)})}catch(e){i(e)}})}setupLayers(){this.map.addSource("stations",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),this.map.addSource("route",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),this.map.addSource("branch-lines",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),this.map.addLayer({id:"branch-lines-layer",type:"line",source:"branch-lines",layout:{"line-join":"round","line-cap":"round","line-sort-key":["get","z_index"]},paint:{"line-color":["match",["get","line_id"],"bakerloo","#B36305","central","#E32017","circle","#FFD300","district","#00782A","hammersmith-city","#F3A9BB","jubilee","#A0A5A9","metropolitan","#9B0056","northern","#000000","piccadilly","#003688","victoria","#0098D4","waterloo-city","#95CDBA","dlr","#00A4A7","elizabeth","#6950a1","tram","#84B817","liberty","#7C878E","lioness","#FDB913","mildmay","#0056A3","suffragette","#00853E","weaver","#7B4391","windrush","#E02636","london-overground","#EE7C0E","overground","#EE7C0E","c2c","#b7007c","chiltern-railways","#00bfff","east-midlands-railway","#713563","greater-anglia","#d70428","great-western-railway","#0a493e","heathrow-express","#532e63","london-north-eastern-railway","#ce0e2d","southeastern","#389cff","southern","#8cc63e","south-western-railway","#24398c","thameslink","#ff5aa4","west-midlands-trains","#ff8300","avanti-west-coast","#004354","northern-rail","#0f0d78","transpennine-express","#09a4ec","#888888"],"line-width":4,"line-opacity":.7}}),this.map.addLayer({id:"route-line",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":["get","color"],"line-width":5,"line-opacity":.9}}),this.map.addLayer({id:"route-line-outline",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#ffffff","line-width":7,"line-opacity":.3}},"route-line"),this.map.addLayer({id:"stations-points",type:"circle",source:"stations",filter:["!",[">=",["to-number",["get","fare"],-1],0]],paint:{"circle-radius":["interpolate",["linear"],["zoom"],9,3,14,8],"circle-color":"#ffffff","circle-opacity":.6,"circle-stroke-width":1,"circle-stroke-color":"#a0a0b0"}}),this.map.addLayer({id:"stations-heatmap",type:"circle",source:"stations",filter:["all",[">=",["to-number",["get","fare"],-1],0],["!=",["get","isOnBranch"],!0]],paint:{"circle-radius":["interpolate",["linear"],["zoom"],9,4,14,10],"circle-color":["case",["==",["get","timeMode"],"peak"],["interpolate",["linear"],["get","fare"],...C.flat()],["interpolate",["linear"],["get","fare"],...b.flat()]],"circle-opacity":.9,"circle-stroke-width":1,"circle-stroke-color":"#ffffff","circle-stroke-opacity":.5}}),this.map.addLayer({id:"stations-branch-background",type:"circle",source:"stations",filter:["all",[">=",["to-number",["get","fare"],-1],0],["==",["get","isOnBranch"],!0]],paint:{"circle-color":"#ffffff","circle-radius":16,"circle-stroke-width":3,"circle-stroke-color":["case",["==",["get","timeMode"],"peak"],["interpolate",["linear"],["get","fare"],...C.flat()],["interpolate",["linear"],["get","fare"],...b.flat()]],"circle-opacity":1}}),this.map.addLayer({id:"stations-fare-labels",type:"symbol",source:"stations",filter:["all",[">=",["to-number",["get","fare"],-1],0],["==",["get","isOnBranch"],!0]],layout:{"text-field":["get","fare_text"],"text-font":["Noto Sans Regular"],"text-size":12,"text-variable-anchor":["center"],"text-justify":"center","text-allow-overlap":!0},paint:{"text-color":"#000000","text-halo-color":"#ffffff","text-halo-width":.5}}),this.map.addLayer({id:"station-origin",type:"circle",source:"stations",filter:["==",["get","isOrigin"],!0],paint:{"circle-radius":12,"circle-color":"#00d4ff","circle-stroke-width":3,"circle-stroke-color":"#ffffff"}}),this.map.addLayer({id:"station-destination",type:"circle",source:"stations",filter:["==",["get","isDestination"],!0],paint:{"circle-radius":12,"circle-color":"#6366f1","circle-stroke-width":3,"circle-stroke-color":"#ffffff"}}),this.map.on("click",["stations-points","stations-heatmap","station-origin","station-destination","stations-branch-background","stations-fare-labels"],t=>{if(t.features&&t.features.length>0){const i=t.features[0].properties.station_id;this.emit("stationClick",i)}}),this.map.on("mouseenter",["stations-points","stations-heatmap","stations-branch-background","stations-fare-labels"],t=>{if(this.map.getCanvas().style.cursor="pointer",this.hoverTimeout&&(clearTimeout(this.hoverTimeout),this.hoverTimeout=null),t.features&&t.features.length>0){const i=t.features[0].properties.station_id,e={x:t.point.x,y:t.point.y};this.hoverTimeout=setTimeout(()=>{this.emit("stationHover",i,e)},300)}}),this.map.on("mouseleave",["stations-points","stations-heatmap","stations-branch-background","stations-fare-labels"],()=>{this.map.getCanvas().style.cursor="",this.hoverTimeout&&(clearTimeout(this.hoverTimeout),this.hoverTimeout=null),this.emit("stationHoverEnd")})}addStations(t){const i=t.map(e=>(this.stationsById[e.station_id]=e,{type:"Feature",geometry:{type:"Point",coordinates:[e.lon,e.lat]},properties:{station_id:e.station_id,common_name:e.common_name,zone:e.zone,modes:e.modes,isOrigin:!1,isDestination:!1}}));this.map.getSource("stations").setData({type:"FeatureCollection",features:i})}updateFareHeatmap(t,i=new Set,e="offpeak"){const a=new Map(t.map(r=>[r.dest_id,r.fare])),s=this.map.getSource("stations"),n=(s._data||{features:[]}).features.map(r=>{const c=r.properties.station_id,l=a.get(c),u={...r.properties,fare_text:l!==void 0?`£${(l/100).toFixed(2)}`:"",isOnBranch:i.has(c)&&c!==this.originId,isOrigin:c===this.originId,isDestination:c===this.destinationId,timeMode:e};return l!=null?u.fare=l:delete u.fare,{...r,properties:u}});s.setData({type:"FeatureCollection",features:n})}setOrigin(t){this.originId=t,this.updateStationMarkers();const i=this.stationsById[t];i&&this.map.flyTo({center:[i.lon,i.lat],zoom:Math.max(this.map.getZoom(),12),duration:800})}setDestination(t){if(this.destinationId=t,this.updateStationMarkers(),this.originId&&this.destinationId){const i=this.stationsById[this.originId],e=this.stationsById[this.destinationId];if(i&&e){const a=new _.LngLatBounds().extend([i.lon,i.lat]).extend([e.lon,e.lat]);this.map.fitBounds(a,{padding:{top:100,bottom:100,left:400,right:100},duration:800})}}}updateStationMarkers(){const t=this.map.getSource("stations");if(!t||!t._data)return;const i=t._data.features.map(e=>({...e,properties:{...e.properties,isOrigin:e.properties.station_id===this.originId,isDestination:e.properties.station_id===this.destinationId}}));t.setData({type:"FeatureCollection",features:i})}drawRoute(t){if(!t){console.error("[Map] drawRoute called with null connections");return}const i=t.map((e,a)=>{a===0&&console.log("[Map] drawRoute first connection:",{source:e.source_station_id,target:e.target_station_id,line:e.line_id,hasCoords:!!e.coordinates,coordsIsArray:Array.isArray(e.coordinates),coordsLength:e.coordinates?e.coordinates.length:0,firstPoint:e.coordinates&&e.coordinates.length>0?e.coordinates[0]:"empty",firstPointType:e.coordinates&&e.coordinates.length>0?typeof e.coordinates[0]:"N/A",firstPointIsArray:e.coordinates&&e.coordinates.length>0?Array.isArray(e.coordinates[0]):"N/A",rawCoords:e.coordinates});const s=e.coordinates;let o=null,n=!1;Array.isArray(s)&&s.length>=2&&(n=s.every((l,u)=>{const p=Array.isArray(l)&&l.length>=2&&typeof l[0]=="number"&&!isNaN(l[0])&&typeof l[1]=="number"&&!isNaN(l[1]);return!p&&a===0&&console.warn(`[Map] Invalid point at ${u}:`,l,`IsArray: ${Array.isArray(l)}`),p})),n?o=s:(s&&s.length>0&&console.warn(`[Map] Invalid coordinates values detected for connection ${a} (${e.source_station_id}->${e.target_station_id}). Falling back.`),e.source_lat&&e.source_lon&&e.target_lat&&e.target_lon?o=[[e.source_lon,e.source_lat],[e.target_lon,e.target_lat]]:(console.warn(`[Map] No valid coordinates for connection ${a} AND missing station lat/lon.`),o=[[e.source_lon||0,e.source_lat||0],[e.target_lon||0,e.target_lat||0]]));const r=(e.line_id||e.line_name||"").toLowerCase(),c=A[r]||A.default;return{type:"Feature",geometry:{type:"LineString",coordinates:o},properties:{line_name:e.line_name,line_id:e.line_id,color:c,sequence:a}}});this.map.getSource("route").setData({type:"FeatureCollection",features:i})}clearRoute(){this.map.getSource("route").setData({type:"FeatureCollection",features:[]})}updateBranchLines(t){var i;if(console.log(`[Map] updateBranchLines received ${((i=t==null?void 0:t.features)==null?void 0:i.length)||0} features`),t&&t.features){const e=new Set(["bakerloo","central","circle","district","hammersmith-city","jubilee","metropolitan","northern","piccadilly","victoria","waterloo-city","dlr","elizabeth","elizabeth-line"]),a=new Set(["liberty","lioness","mildmay","suffragette","weaver","windrush","london-overground","overground","tram"]);t.features.forEach(s=>{const o=s.properties.line_id;let n=10;e.has(o)?n=30:a.has(o)&&(n=20),s.properties.z_index=n})}this.map.getSource("branch-lines").setData(t)}clearBranchLines(){this.map.getSource("branch-lines").setData({type:"FeatureCollection",features:[]})}clearFares(){this.clearBranchLines();const t=this.map.getSource("stations");if(t&&t._data){const i=t._data.features.map(e=>{const a={...e.properties,fare:null,fare_text:"",isOnBranch:!1};return{...e,properties:a}});t.setData({type:"FeatureCollection",features:i})}}clearSelection(){this.originId=null,this.destinationId=null,this.updateStationMarkers(),this.clearRoute(),this.clearBranchLines();const t=this.map.getSource("stations");if(t&&t._data){const i=t._data.features.map(e=>({...e,properties:{...e.properties,fare:null,fare_text:"",isOnBranch:!1,isOrigin:!1,isDestination:!1}}));t.setData({type:"FeatureCollection",features:i})}}on(t,i){this.eventHandlers[t]||(this.eventHandlers[t]=[]),this.eventHandlers[t].push(i)}emit(t,...i){(this.eventHandlers[t]||[]).forEach(a=>a(...i))}}function y(h){return h==null?"—":`£${(h/100).toFixed(2)}`}function B(h){return h==null?"—":`${h.toFixed(1)} km`}class x{constructor(){this.eventHandlers={},this.originInfo=null,this.routesPanel=null,this.destinationInfo=null,this.routeList=null,this.tooltip=null,this.fareSlider=null,this.fareValue=null,this.activeRouteId=null}init(){this.originInfo=document.getElementById("origin-info"),this.clearOriginBtn=document.getElementById("clear-origin-btn"),this.routesPanel=document.getElementById("routes-panel"),this.destinationPanel=document.getElementById("destination-panel"),this.destinationInfo=document.getElementById("destination-info"),this.routeList=document.getElementById("route-list"),this.tooltip=document.getElementById("tooltip"),this.fareSlider=document.getElementById("fare-slider"),this.fareValue=document.getElementById("fare-value"),this.setupFilterListeners()}setupFilterListeners(){this.fareSlider&&this.fareSlider.addEventListener("input",t=>{const i=parseInt(t.target.value,10);this.fareValue.textContent=y(i),this.emit("fareChange",i)}),document.querySelectorAll("[data-sort]").forEach(t=>{t.addEventListener("click",()=>{document.querySelectorAll("[data-sort]").forEach(i=>i.classList.remove("active")),t.classList.add("active"),this.emit("sortChange",t.dataset.sort)})}),document.querySelectorAll("[data-time]").forEach(t=>{t.addEventListener("click",()=>{document.querySelectorAll("[data-time]").forEach(i=>i.classList.remove("active")),t.classList.add("active"),this.emit("timeChange",t.dataset.time)})}),this.clearOriginBtn&&this.clearOriginBtn.addEventListener("click",()=>{this.emit("clearSelection")})}formatLineNames(t){if(!t||t.length===0)return"";const i={"hammersmith-city":"H&C","waterloo-city":"W&C",elizabeth:"Elizabeth",dlr:"DLR"};return t.map(e=>{let a;return i[e]?a=i[e]:a=e.split("-").map(s=>s.charAt(0).toUpperCase()+s.slice(1)).join(" "),`<span class="line-badge line-${e.toLowerCase()}">${a}</span>`}).join("")}setOrigin(t,i){if(!this.originInfo)return;this.clearOriginBtn&&this.clearOriginBtn.classList.remove("hidden");const e=i&&i.length>0?this.formatLineNames(i):t.modes;this.originInfo.innerHTML=`
      <div class="station-name">${t.common_name}</div>
      <div class="station-meta">
        <span class="zone-badge">Zone ${t.zone}</span>
        <span>${e}</span>
      </div>
    `,this.originInfo.classList.add("animate-slide-up"),this.destinationPanel&&this.destinationInfo&&(this.destinationPanel.classList.remove("hidden"),this.destinationInfo.innerHTML='<p class="hint">Click a station on the map</p>')}setDestination(t){this.destinationInfo&&(this.destinationPanel&&this.destinationPanel.classList.remove("hidden"),this.destinationInfo.innerHTML=`
      <div class="station-name">${t.common_name}</div>
      <div class="station-meta">
        <span class="zone-badge">Zone ${t.zone}</span>
      </div>
    `)}showRoutes(t){!this.routesPanel||!this.routeList||(this.routesPanel.classList.remove("hidden"),this.routeList.innerHTML="",t.forEach((i,e)=>{const a=document.createElement("li");a.className="route-item",e===0&&(a.classList.add("active"),this.activeRouteId=i.route_id),a.dataset.routeId=i.route_id;const s=[];i.is_default&&s.push('<span class="route-badge default">Default</span>'),a.innerHTML=`
        <div class="route-header">
          <span class="route-fare">${y(i.fare_pence)}</span>
          <span class="route-distance">${B(i.haversine_distance_km)}</span>
        </div>
        <div class="route-description">
          ${s.join("")}
          ${i.description||"Direct route"}
        </div>
      `,a.addEventListener("click",()=>{this.setActiveRoute(i.route_id),this.emit("routeSelect",i.route_id)}),this.routeList.appendChild(a)}))}setActiveRoute(t){this.activeRouteId=t,document.querySelectorAll(".route-item").forEach(i=>{i.classList.toggle("active",i.dataset.routeId===t)})}showTooltip(t,i,e,a){if(!this.tooltip)return;const s=this.tooltip.querySelector(".tooltip-name"),o=this.tooltip.querySelector(".tooltip-zone"),n=this.tooltip.querySelector(".tooltip-lines"),r=this.tooltip.querySelector(".tooltip-fare.cheapest .fare-value"),c=this.tooltip.querySelector(".tooltip-fare.default .fare-value");if(s&&(s.textContent=t.common_name),o&&(o.textContent=`Zone ${t.zone}`),n&&(a&&a.length>0?(n.innerHTML=this.formatLineNames(a),n.classList.remove("hidden")):(n.innerHTML="",n.classList.add("hidden"))),r&&i&&(r.textContent=y(i.cheapest_offpeak)),c&&i){const F=i.default_fare_offpeak!==null?i.default_fare_offpeak:i.cheapest_offpeak;c.textContent=y(F)}this.tooltip.style.opacity="0",this.tooltip.classList.remove("hidden");const l=this.tooltip.getBoundingClientRect(),u=l.width,p=l.height,E=this.tooltip.parentElement,S=E.offsetWidth,L=E.offsetHeight,O=15,f=10;let g=e.x-u/2;g<f?g=f:g+u>S-f&&(g=S-u-f);let m=e.y-p-O;m<f&&(m=e.y+O,m+p>L-f&&(m=Math.min(m,L-p-f))),this.tooltip.style.transform="none",this.tooltip.style.marginTop="0",this.tooltip.style.left=`${g}px`,this.tooltip.style.top=`${m}px`,requestAnimationFrame(()=>{this.tooltip.style.opacity="1"})}hideTooltip(){this.tooltip&&(this.tooltip.classList.add("hidden"),this.tooltip.style.left="",this.tooltip.style.top="",this.tooltip.style.transform="",this.tooltip.style.marginTop="",this.tooltip.style.opacity="")}updateStats(t){const i=document.getElementById("station-count"),e=document.getElementById("fare-count");i&&(i.textContent=t.stationCount.toLocaleString()),e&&(e.textContent=t.fareCount.toLocaleString())}clearSelection(){this.originInfo&&(this.originInfo.innerHTML='<p class="hint">Click a station on the map</p>'),this.clearOriginBtn&&this.clearOriginBtn.classList.add("hidden"),this.routesPanel&&this.routesPanel.classList.add("hidden"),this.destinationPanel&&this.destinationPanel.classList.add("hidden"),this.routeList&&(this.routeList.innerHTML=""),this.activeRouteId=null}on(t,i){this.eventHandlers[t]||(this.eventHandlers[t]=[]),this.eventHandlers[t].push(i)}emit(t,...i){(this.eventHandlers[t]||[]).forEach(a=>a(...i))}}class P{constructor(t,i){this.nodes=new Map,this.graph=new Map,t.forEach(s=>{this.nodes.set(s.station_id,{id:s.station_id,lat:s.lat,lon:s.lon,name:s.common_name}),this.graph.set(s.station_id,[])}),console.log(`[PathFinder] Indexed ${this.nodes.size} stations.`);let e=0;i.forEach(s=>{let o=s.haversine_distance_km;(typeof o!="number"||isNaN(o))&&(o=this.heuristic(s.source_station_id,s.target_station_id)),isNaN(o)&&(o=.5),(s.source_station_id==="940GZZLUWYP"||s.target_station_id==="940GZZLUWYP"||s.source_station_id==="940GZZLUFYR"||s.target_station_id==="940GZZLUFYR")&&console.log(`[PathFinder] Debug Connection ${s.source_station_id}->${s.target_station_id}:`,{hasCoords:!!s.coordinates,isArray:Array.isArray(s.coordinates),length:s.coordinates?s.coordinates.length:0,sample:s.coordinates&&s.coordinates.length>0?s.coordinates[0]:"empty",sampleType:s.coordinates&&s.coordinates.length>0?typeof s.coordinates[0]:"N/A",sampleIsArray:s.coordinates&&s.coordinates.length>0?Array.isArray(s.coordinates[0]):"N/A"}),this.addConnection(s.source_station_id,s.target_station_id,o,s.line_name,s.line_mode,s.coordinates,s.line_id);let n=null;Array.isArray(s.coordinates)&&(n=[...s.coordinates].reverse()),this.addConnection(s.target_station_id,s.source_station_id,o,s.line_name,s.line_mode,n,s.line_id),e+=2}),console.log(`[PathFinder] Graph built with ${e} edges.`);const a="940GZZLUGDG";this.graph.has(a)?console.log(`[PathFinder] Debug: Node ${a} has ${this.graph.get(a).length} neighbors.`):console.warn(`[PathFinder] Debug: Node ${a} NOT found in graph!`)}addConnection(t,i,e,a,s,o,n){this.graph.has(t)||this.graph.set(t,[]);const r=this.graph.get(t);r.some(l=>l.node===i&&l.lineId===n)||r.push({node:i,weight:e,lineName:a,lineId:n,mode:s,coordinates:o})}heuristic(t,i){const e=this.nodes.get(t),a=this.nodes.get(i);if(!e||!a)return 0;const s=6371,o=this.toRad(a.lat-e.lat),n=this.toRad(a.lon-e.lon),r=Math.sin(o/2)*Math.sin(o/2)+Math.cos(this.toRad(e.lat))*Math.cos(this.toRad(a.lat))*Math.sin(n/2)*Math.sin(n/2),c=2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r));return s*c}toRad(t){return t*(Math.PI/180)}findPath(t,i){return console.log("[PathFinder] findPath disabled. Returning null."),null}reconstructPath(t,i){const e=[];let a=i,s=0;for(;t.has(a);){const o=t.get(a),n=this.nodes.get(o.from),r=this.nodes.get(a);n||console.warn(`[PathFinder] Missing source node for ${o.from}`),r||console.warn(`[PathFinder] Missing target node for ${a}`),e.unshift({source_station_id:o.from,target_station_id:a,line_name:o.lineName,line_id:o.lineId,line_mode:o.mode,haversine_distance_km:o.weight,coordinates:o.coordinates,source_lat:n?n.lat:0,source_lon:n?n.lon:0,target_lat:r?r.lat:0,target_lon:r?r.lon:0}),s+=o.weight,a=o.from}return console.log(`[PathFinder] Reconstructed path with ${e.length} steps. Total distance: ${s}`),{route_id:"calculated_shortest",description:this.generateDescription(e),is_default:!0,haversine_distance_km:s,fare_pence:null,connections:e}}generateDescription(t){if(t.length===0)return"Same station";const i=new Set(t.map(e=>e.line_name));return Array.from(i).join(", ")}}const w={map:{style:"https://tiles.openfreemap.org/styles/liberty",center:[-.118092,51.509865],zoom:11,minZoom:9,maxZoom:16},data:{basePath:"./data",files:{stations:"stations.parquet",fares:"fares.parquet",routes:"routes.parquet",connections:"connections.parquet"}}};class H{constructor(){this.db=null,this.map=null,this.ui=null,this.pathFinder=null,this.selectedOrigin=null,this.selectedDestination=null,this.sortMode="default",this.timeMode="offpeak",this.maxFare=1e3}async init(){try{this.updateLoadingText("Initializing DuckDB-WASM..."),this.db=new M,await this.db.init(),this.updateLoadingText("Loading data files..."),await this.db.loadParquetFiles(w.data.basePath,w.data.files),this.updateLoadingText("Initializing map..."),this.map=new k("map",w.map),await this.map.init(),this.ui=new x,this.ui.init();const t=await this.db.getAllStations();this.map.addStations(t);const i=await this.db.getAllConnections();console.log(`[App] Loaded ${i.length} connections for PathFinder.`),this.pathFinder=new P(t,i);const e=await this.db.getStats();this.ui.updateStats(e),this.setupEventHandlers(),this.showApp(),console.info("FareMap initialized successfully")}catch(t){console.error("Failed to initialize FareMap:",t),this.showError(t.message)}}setupEventHandlers(){this.map.on("stationClick",async t=>{await this.handleStationClick(t)}),this.map.on("stationHover",async(t,i)=>{this.selectedOrigin&&t!==this.selectedOrigin&&await this.handleStationHover(t,i)}),this.map.on("stationHoverEnd",()=>{this.ui.hideTooltip()}),this.ui.on("routeSelect",async t=>{if(t==="calculated_shortest"){const i=this.pathFinder.findPath(this.selectedOrigin,this.selectedDestination);await this.handleRouteSelect(t,i)}else await this.handleRouteSelect(t)}),this.ui.on("sortChange",async t=>{this.sortMode=t,await this.refreshFareVisualization()}),this.ui.on("timeChange",async t=>{this.timeMode=t,await this.refreshFareVisualization()}),this.ui.on("fareChange",async t=>{this.maxFare=t,await this.refreshFareVisualization()}),this.ui.on("clearSelection",()=>{this.clearSelection()})}async handleStationClick(t){if(this.selectedOrigin)if(t===this.selectedOrigin)this.clearSelection();else{this.selectedDestination=t;const i=await this.db.getStation(t);let a=[...await this.db.getRouteOptions(this.selectedOrigin,t,this.timeMode)];if(this.pathFinder){console.log(`[App] calculating shortest path from ${this.selectedOrigin} to ${t}`);const s=this.pathFinder.findPath(this.selectedOrigin,t);s?(console.log("[App] Shortest path found:",s),s.description=`⚡ ${s.description}`,a.unshift(s)):console.warn("[App] No shortest path found via A*")}this.ui.setDestination(i),this.ui.showRoutes(a),this.map.setDestination(t),a.length>0&&(this.map.clearFares(),await this.handleRouteSelect(a[0].route_id,a[0]))}else{this.selectedOrigin=t;const i=await this.db.getStation(t),e=await this.db.getLinesAtStation(t);this.ui.setOrigin(i,e),this.map.setOrigin(t),await this.refreshFareVisualization()}}async handleStationHover(t,i){const e=await this.db.getStation(t),a=await this.db.getFareSummary(this.selectedOrigin,t),s=await this.db.getLinesAtStation(t);this.ui.showTooltip(e,a,i,s)}async handleRouteSelect(t,i){console.log(`[App] handleRouteSelect executing for routeId: ${t}`);let e;t==="calculated_shortest"&&i?e=i.connections:e=await this.db.getRouteConnections(t),(!e||e.length===0)&&console.warn("[App] No connections found for route!"),this.map.drawRoute(e),this.ui.setActiveRoute(t)}async refreshFareVisualization(){if(!this.selectedOrigin)return;const t=await this.db.getFaresFromOrigin(this.selectedOrigin,this.sortMode,this.timeMode,this.maxFare),i=await this.db.getLinesAtStation(this.selectedOrigin),e=await this.db.getStationsOnLines(i),a=await this.db.getRouteGeometry(i);this.map.updateBranchLines(a),this.map.updateFareHeatmap(t,e,this.timeMode)}clearSelection(){this.selectedOrigin=null,this.selectedDestination=null,this.ui.clearSelection(),this.map.clearSelection()}updateLoadingText(t){const i=document.querySelector(".loading-text");i&&(i.textContent=t)}showApp(){const t=document.getElementById("loading-screen"),i=document.getElementById("app");t&&t.classList.add("hidden"),i&&i.classList.remove("hidden")}showError(t){const i=document.querySelector(".loading-text");i&&(i.textContent=`Error: ${t}`,i.style.color="var(--accent-error)")}}document.addEventListener("DOMContentLoaded",()=>{new H().init()});
