import{r as N,g as D}from"./maplibre-BbqsL0sN.js";import{J as R,X as v,A as T,f as I}from"./duckdb-CXkSyTZP.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();var M=N();const S=D(M);class ${constructor(){this.db=null,this.conn=null,this.initialized=!1}async init(){try{const t=R(),e=await v(t),s=URL.createObjectURL(new Blob([`importScripts("${e.mainWorker}");`],{type:"text/javascript"})),i=new Worker(s),n=new T;this.db=new I(n,i),await this.db.instantiate(e.mainModule,e.pthreadWorker),this.conn=await this.db.connect(),this.initialized=!0,console.info("DuckDB-WASM initialized successfully")}catch(t){throw console.error("Failed to initialize DuckDB:",t),new Error(`DuckDB initialization failed: ${t.message}`)}}async loadParquetFiles(t,e){if(!this.initialized)throw new Error("DuckDB not initialized");const i=`${typeof window<"u"?window.location.origin:""}${t.startsWith("/")?"":"/"}${t}`;try{for(const[n,a]of Object.entries(e)){const o=`${i}/${a}?v=${Date.now()}`,l=`${i}/${a.replace(".parquet",".json")}?v=${Date.now()}`;let c=!1;try{await this.conn.query(`
            CREATE OR REPLACE VIEW ${n} AS 
            SELECT * FROM read_parquet('${o}')
          `),console.info(`Loaded ${n} from Parquet: ${o}`),c=!0}catch{console.warn(`Parquet load failed for ${n}, trying JSON...`)}if(!c)try{await this.conn.query(`
              CREATE OR REPLACE VIEW ${n} AS 
              SELECT * FROM read_json_auto('${l}')
            `),console.info(`Loaded ${n} from JSON: ${l}`)}catch(r){throw new Error(`Failed to load ${n}: ${r.message}`)}}}catch(n){throw console.error("Failed to load data files:",n),new Error(`Failed to load data: ${n.message}`)}}async getAllStations(){const t=await this.conn.query(`
      SELECT 
        station_id,
        common_name,
        lat,
        lon,
        zone,
        modes
      FROM stations
      ORDER BY common_name
    `);return this.arrowToArray(t)}async getStation(t){const e=await this.conn.query(`
      SELECT 
        station_id,
        common_name,
        lat,
        lon,
        zone,
        modes
      FROM stations
      WHERE station_id = '${this.escape(t)}'
      LIMIT 1
    `),s=this.arrowToArray(e);return s.length>0?s[0]:null}async getAllConnections(){const t=await this.conn.query(`
      SELECT 
        c.source_station_id,
        c.target_station_id,
        c.line_id,
        c.line_name,
        c.line_mode,
        c.haversine_distance_km,
        c.coordinates
      FROM connections c
    `),e=this.arrowToArray(t);return e.forEach((s,i)=>{let n=s.coordinates;if(typeof n=="string")try{let a=JSON.parse(n);typeof a=="string"&&(a=JSON.parse(a)),s.coordinates=a}catch(a){console.warn(`[DuckDB] Failed to parse coordinates for connection ${i}:`,a),s.coordinates=null}}),e}async getFaresFromOrigin(t,e="cheapest",s="offpeak",i=1500){const n=s==="peak"?"payg_peak_pence":"payg_offpeak_pence";let a;switch(e){case"default":a=`r.is_default DESC, f.${n} ASC`;break;case"cheapest":default:a=`f.${n} ASC`}const o=await this.conn.query(`
      WITH ranked_fares AS (
        SELECT 
          f.dest_id,
          f.${n} as fare,
          s.common_name,
          s.lat,
          s.lon,
          s.zone,
          ROW_NUMBER() OVER (
            PARTITION BY f.dest_id 
            ORDER BY ${a}
          ) as rn
        FROM fares f
        JOIN stations s ON f.dest_id = s.station_id
        LEFT JOIN routes r ON f.route_id = r.route_id
        WHERE f.origin_id = '${this.escape(t)}'
          AND f.${n} <= ${i}
      )
      SELECT * FROM ranked_fares
      WHERE rn = 1
      ORDER BY fare ASC
    `);return this.arrowToArray(o)}async getLinesAtStation(t){const e=await this.conn.query(`
      SELECT DISTINCT line_name
      FROM connections
      WHERE source_station_id = '${this.escape(t)}'
         OR target_station_id = '${this.escape(t)}'
    `);return this.arrowToArray(e).map(i=>i.line_name)}async getStationsOnLines(t){if(!t||t.length===0)return new Set;const e=t.map(n=>`'${this.escape(n)}'`).join(","),s=await this.conn.query(`
      SELECT DISTINCT source_station_id as id
      FROM connections
      WHERE line_name IN (${e})
      UNION
      SELECT DISTINCT target_station_id as id
      FROM connections
      WHERE line_name IN (${e})
    `),i=this.arrowToArray(s);return new Set(i.map(n=>n.id))}async getConnectionsOnLines(t){if(!t||t.length===0)return[];const e=t.map(i=>`'${this.escape(i)}'`).join(","),s=await this.conn.query(`
      SELECT DISTINCT
        c.source_station_id,
        c.target_station_id,
        lower(c.line_name) as line_name,
        s1.lat as source_lat,
        s1.lon as source_lon,
        s2.lat as target_lat,
        s2.lon as target_lon
      FROM connections c
      JOIN stations s1 ON c.source_station_id = s1.station_id
      JOIN stations s2 ON c.target_station_id = s2.station_id
      WHERE c.line_name IN (${e})
    `);return this.arrowToArray(s)}async getRouteGeometry(t){if(!t||t.length===0)return{type:"FeatureCollection",features:[]};const e=t.map(a=>`'${this.escape(a)}'`).join(","),s=await this.conn.query(`
      SELECT DISTINCT
        c.source_station_id,
        c.target_station_id,
        c.line_id,
        c.line_name,
        c.branch_name as branch_index,
        c.coordinates,
        s1.lat as source_lat,
        s1.lon as source_lon,
        s2.lat as target_lat,
        s2.lon as target_lon
      FROM connections c
      JOIN stations s1 ON c.source_station_id = s1.station_id
      JOIN stations s2 ON c.target_station_id = s2.station_id
      WHERE c.line_name IN (${e})
    `);return{type:"FeatureCollection",features:this.arrowToArray(s).map(a=>{let o=[];if(Array.isArray(a.coordinates))o=a.coordinates;else try{typeof a.coordinates=="string"&&(o=JSON.parse(a.coordinates),typeof o=="string"&&(o=JSON.parse(o)))}catch(u){console.warn(`Failed to parse route geometry for ${a.line_id}:`,u)}let l="LineString";const c=u=>Array.isArray(u)||u&&typeof u=="object"&&typeof u.length=="number";o.length>0&&c(o[0])&&c(o[0][0])&&(l="MultiLineString");const r={type:"Feature",geometry:{type:l,coordinates:o},properties:{line_id:a.line_id,line_name:a.line_name,branch_index:a.branch_index,source_station_id:a.source_station_id,target_station_id:a.target_station_id}},d=u=>{const E=m=>Array.isArray(m)||m&&typeof m=="object"&&typeof m.length=="number";return!E(u)||u.length<2?!1:Array.from(u).every(m=>{let y=m;if(!Array.isArray(m)&&!ArrayBuffer.isView(m)&&E(m))try{y=Array.from(m)}catch{}if(!E(y)||y.length<2)return!1;const g=y[0],_=y[1];return typeof g=="number"&&!isNaN(g)&&typeof _=="number"&&!isNaN(_)})};let p=!1;return r.geometry.type==="LineString"?p=d(r.geometry.coordinates):r.geometry.type==="MultiLineString"&&(p=r.geometry.coordinates.every(u=>d(u))),p?r:(console.warn(`[DuckDB] Invalid geometry for ${r.properties.line_id} and no fallback available.`),null)}).filter(a=>a!==null)}}async getRouteOptions(t,e,s="offpeak"){const i=s==="peak"?"payg_peak_pence":"payg_offpeak_pence",n=await this.conn.query(`
      SELECT 
        f.route_id,
        r.description,
        r.validator_info,
        r.is_default,

        f.${i} as fare_pence,
        f.passenger_type
      FROM fares f
      JOIN routes r ON f.route_id = r.route_id
      WHERE f.origin_id = '${this.escape(t)}'
        AND f.dest_id = '${this.escape(e)}'
      ORDER BY 
        r.is_default DESC,
        f.${i} ASC
    `);return this.arrowToArray(n)}async getFareSummary(t,e){const s=await this.conn.query(`
      SELECT 
        MIN(payg_offpeak_pence) as cheapest_offpeak,
        MIN(payg_peak_pence) as cheapest_peak,
        
        -- Default route fare (takes the minimum if multiple default routes exist, though usually one)
        MIN(CASE WHEN r.is_default THEN payg_offpeak_pence END) as default_fare_offpeak,
        MIN(CASE WHEN r.is_default THEN payg_peak_pence END) as default_fare_peak
      FROM fares f
      LEFT JOIN routes r ON f.route_id = r.route_id
      WHERE f.origin_id = '${this.escape(t)}'
        AND f.dest_id = '${this.escape(e)}'
    `),i=this.arrowToArray(s);return i.length>0?i[0]:null}async getRouteConnections(t){const e=await this.conn.query(`
      SELECT 
        c.source_station_id,
        c.source_station_id,
        c.target_station_id,
        c.line_id,
        c.line_mode,
        c.line_name,
        c.coordinates,
        s1.lat as source_lat,
        s1.lon as source_lon,
        s2.lat as target_lat,
        s2.lon as target_lon
      FROM connections c
      JOIN stations s1 ON c.source_station_id = s1.station_id
      JOIN stations s2 ON c.target_station_id = s2.station_id
      -- Note: In a real implementation we would filter by route_id
      -- For this demo, we might need to pass a specific station list or just trust the pathfinder
      WHERE 1=0 -- Still disabled until we have route_id back in connections for precise selection
      -- OR we change this to take a list of (start, end) pairs?
    `),s=this.arrowToArray(e);return s.forEach((i,n)=>{let a=i.coordinates;if(typeof a=="string")try{a=JSON.parse(a),typeof a=="string"&&(a=JSON.parse(a)),i.coordinates=a}catch(o){console.warn(`[DuckDB] Failed to parse coordinates for connection ${n}:`,o)}}),s}async getStats(){var n,a;const t=await this.conn.query("SELECT COUNT(*) as count FROM stations"),e=await this.conn.query("SELECT COUNT(*) as count FROM fares"),s=this.arrowToArray(t),i=this.arrowToArray(e);return{stationCount:((n=s[0])==null?void 0:n.count)||0,fareCount:((a=i[0])==null?void 0:a.count)||0}}arrowToArray(t){const e=[],s=t.schema.fields.map(n=>n.name),i=n=>n==null?n:typeof n=="bigint"?Number(n):(n&&typeof n.toJSON=="function"&&(n=n.toJSON()),Array.isArray(n)?n.map(i):ArrayBuffer.isView(n)?Array.from(n):n);for(const n of t.batches)for(let a=0;a<n.numRows;a++){const o={};for(const l of s){let c=n.getChildAt(s.indexOf(l)).get(a);o[l]=i(c)}e.push(o)}return e}escape(t){return String(t).replace(/'/g,"''")}async close(){this.conn&&await this.conn.close(),this.db&&await this.db.terminate(),this.initialized=!1}}const A={bakerloo:"#B36305",central:"#E32017",circle:"#FFD300",district:"#00782A","hammersmith-city":"#F3A9BB",jubilee:"#A0A5A9",metropolitan:"#9B0056",northern:"#000000",piccadilly:"#003688",victoria:"#0098D4","waterloo-city":"#95CDBA",dlr:"#00A4A7",elizabeth:"#6950a1","elizabeth-line":"#6950a1",tram:"#84B817",liberty:"#7C878E",lioness:"#FDB913",mildmay:"#0056A3",suffragette:"#00853E",weaver:"#7B4391",windrush:"#E02636","london-overground":"#EE7C0E",overground:"#EE7C0E",c2c:"#b7007c","chiltern-railways":"#00bfff","east-midlands-railway":"#713563","greater-anglia":"#d70428","great-western-railway":"#0a493e","heathrow-express":"#532e63","london-north-eastern-railway":"#ce0e2d",southeastern:"#389cff",southern:"#8cc63e","south-western-railway":"#24398c",thameslink:"#ff5aa4","west-midlands-trains":"#ff8300","avanti-west-coast":"#004354",default:"#888888"},h=["#22c55e","#55a558","#898551","#a2744e","#af6c4c","#bc644b","#c85c49","#d55447","#ef4444"],C=[[290,h[0]],[350,h[1]],[380,h[2]],[460,h[3]],[520,h[4]],[580,h[5]],[670,h[6]],[820,h[7]],[830,h[8]]],b=[[280,h[0]],[290,h[1]],[310,h[2]],[340,h[3]],[360,h[4]],[380,h[5]],[490,h[6]],[491,h[7]],[500,h[8]]];class k{constructor(t,e){this.containerId=t,this.config=e,this.map=null,this.eventHandlers={},this.stationsById={},this.originId=null,this.destinationId=null,this.hoverTimeout=null}async init(){return new Promise((t,e)=>{try{this.map=new S.Map({container:this.containerId,style:this.config.style,center:this.config.center,zoom:this.config.zoom,minZoom:this.config.minZoom,maxZoom:this.config.maxZoom,attributionControl:!0}),this.map.addControl(new S.NavigationControl({showCompass:!1}),"top-right"),this.map.on("load",()=>{this.setupLayers(),t()}),this.map.on("error",s=>{e(s.error)})}catch(s){e(s)}})}setupLayers(){this.map.addSource("stations",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),this.map.addSource("route",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),this.map.addSource("branch-lines",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),this.map.addLayer({id:"branch-lines-layer",type:"line",source:"branch-lines",layout:{"line-join":"round","line-cap":"round","line-sort-key":["get","z_index"]},paint:{"line-color":["match",["get","line_id"],"bakerloo","#B36305","central","#E32017","circle","#FFD300","district","#00782A","hammersmith-city","#F3A9BB","jubilee","#A0A5A9","metropolitan","#9B0056","northern","#000000","piccadilly","#003688","victoria","#0098D4","waterloo-city","#95CDBA","dlr","#00A4A7","elizabeth","#6950a1","tram","#84B817","liberty","#7C878E","lioness","#FDB913","mildmay","#0056A3","suffragette","#00853E","weaver","#7B4391","windrush","#E02636","london-overground","#EE7C0E","overground","#EE7C0E","c2c","#b7007c","chiltern-railways","#00bfff","east-midlands-railway","#713563","greater-anglia","#d70428","great-western-railway","#0a493e","heathrow-express","#532e63","london-north-eastern-railway","#ce0e2d","southeastern","#389cff","southern","#8cc63e","south-western-railway","#24398c","thameslink","#ff5aa4","west-midlands-trains","#ff8300","avanti-west-coast","#004354","northern-rail","#0f0d78","transpennine-express","#09a4ec","#888888"],"line-width":4,"line-opacity":.7}}),this.map.addLayer({id:"route-line",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":["get","color"],"line-width":5,"line-opacity":.9}}),this.map.addLayer({id:"route-line-outline",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#ffffff","line-width":7,"line-opacity":.3}},"route-line"),this.map.addLayer({id:"stations-points",type:"circle",source:"stations",filter:["!",[">=",["to-number",["get","fare"],-1],0]],paint:{"circle-radius":["interpolate",["linear"],["zoom"],9,3,14,8],"circle-color":"#ffffff","circle-opacity":.6,"circle-stroke-width":1,"circle-stroke-color":"#a0a0b0"}}),this.map.addLayer({id:"stations-heatmap",type:"circle",source:"stations",filter:["all",[">=",["to-number",["get","fare"],-1],0],["!=",["get","isOnBranch"],!0]],paint:{"circle-radius":["interpolate",["linear"],["zoom"],9,4,14,10],"circle-color":["case",["==",["get","timeMode"],"peak"],["interpolate",["linear"],["get","fare"],...C.flat()],["interpolate",["linear"],["get","fare"],...b.flat()]],"circle-opacity":.9,"circle-stroke-width":1,"circle-stroke-color":"#ffffff","circle-stroke-opacity":.5}}),this.map.addLayer({id:"stations-branch-background",type:"circle",source:"stations",filter:["all",[">=",["to-number",["get","fare"],-1],0],["==",["get","isOnBranch"],!0],["!=",["get","isDestination"],!0],["!=",["get","isOrigin"],!0]],paint:{"circle-color":"#ffffff","circle-radius":16,"circle-stroke-width":3,"circle-stroke-color":["case",["==",["get","timeMode"],"peak"],["interpolate",["linear"],["get","fare"],...C.flat()],["interpolate",["linear"],["get","fare"],...b.flat()]],"circle-opacity":1}}),this.map.addLayer({id:"station-origin",type:"circle",source:"stations",filter:["==",["get","isOrigin"],!0],paint:{"circle-radius":16,"circle-color":"#ffffff","circle-stroke-width":3,"circle-stroke-color":"#00d4ff"}}),this.map.addLayer({id:"station-destination",type:"circle",source:"stations",filter:["==",["get","isDestination"],!0],paint:{"circle-radius":16,"circle-color":"#ffffff","circle-stroke-width":3,"circle-stroke-color":"#6366f1"}}),this.map.addLayer({id:"stations-fare-labels",type:"symbol",source:"stations",filter:["all",[">=",["to-number",["get","fare"],-1],0],["any",["==",["get","isOnBranch"],!0],["==",["get","isDestination"],!0]]],layout:{"text-field":["get","fare_text"],"text-font":["Noto Sans Regular"],"text-size":12,"text-variable-anchor":["center"],"text-justify":"center","text-allow-overlap":!0},paint:{"text-color":"#000000","text-halo-color":"#ffffff","text-halo-width":1}}),this.map.on("click",["stations-points","stations-heatmap","station-origin","station-destination","stations-branch-background","stations-fare-labels"],t=>{if(t.features&&t.features.length>0){const e=t.features[0].properties.station_id;this.emit("stationClick",e)}}),this.map.on("mouseenter",["stations-points","stations-heatmap","stations-branch-background","stations-fare-labels"],t=>{if(this.map.getCanvas().style.cursor="pointer",this.hoverTimeout&&(clearTimeout(this.hoverTimeout),this.hoverTimeout=null),t.features&&t.features.length>0){const e=t.features[0].properties.station_id,s={x:t.point.x,y:t.point.y};this.hoverTimeout=setTimeout(()=>{this.emit("stationHover",e,s)},300)}}),this.map.on("mouseleave",["stations-points","stations-heatmap","stations-branch-background","stations-fare-labels"],()=>{this.map.getCanvas().style.cursor="",this.hoverTimeout&&(clearTimeout(this.hoverTimeout),this.hoverTimeout=null),this.emit("stationHoverEnd")})}addStations(t){const e=t.map(s=>(this.stationsById[s.station_id]=s,{type:"Feature",geometry:{type:"Point",coordinates:[s.lon,s.lat]},properties:{station_id:s.station_id,common_name:s.common_name,zone:s.zone,modes:s.modes,isOrigin:!1,isDestination:!1}}));this.map.getSource("stations").setData({type:"FeatureCollection",features:e})}updateFareHeatmap(t,e=new Set,s="offpeak"){const i=new Map(t.map(l=>[l.dest_id,l.fare])),n=this.map.getSource("stations"),o=(n._data||{features:[]}).features.map(l=>{const c=l.properties.station_id,r=i.get(c),d={...l.properties,fare_text:r!==void 0?`£${(r/100).toFixed(2)}`:"",isOnBranch:e.has(c)&&c!==this.originId,isOrigin:c===this.originId,isDestination:c===this.destinationId,timeMode:s};return r!=null?d.fare=r:delete d.fare,{...l,properties:d}});n.setData({type:"FeatureCollection",features:o})}setOrigin(t){this.originId=t,this.updateStationMarkers();const e=this.stationsById[t];e&&this.map.flyTo({center:[e.lon,e.lat],zoom:Math.max(this.map.getZoom(),12),duration:800})}setDestination(t){if(this.destinationId=t,this.updateStationMarkers(),this.originId&&this.destinationId){const e=this.stationsById[this.originId],s=this.stationsById[this.destinationId];if(e&&s){const i=new S.LngLatBounds().extend([e.lon,e.lat]).extend([s.lon,s.lat]);this.map.fitBounds(i,{padding:{top:100,bottom:100,left:400,right:100},duration:800})}}}updateStationMarkers(){const t=this.map.getSource("stations");if(!t||!t._data)return;const e=t._data.features.map(s=>({...s,properties:{...s.properties,isOrigin:s.properties.station_id===this.originId,isDestination:s.properties.station_id===this.destinationId}}));t.setData({type:"FeatureCollection",features:e})}drawRoute(t){if(!t){console.error("[Map] drawRoute called with null connections");return}const e=t.map((s,i)=>{const n=s.coordinates;let a=null,o=!1;Array.isArray(n)&&n.length>=2&&(o=n.every((r,d)=>{const p=Array.isArray(r)&&r.length>=2&&typeof r[0]=="number"&&!isNaN(r[0])&&typeof r[1]=="number"&&!isNaN(r[1]);return!p&&i===0&&console.warn(`[Map] Invalid point at ${d}:`,r,`IsArray: ${Array.isArray(r)}`),p})),o&&(a=n);const l=(s.line_id||s.line_name||"").toLowerCase(),c=A[l]||A.default;return{type:"Feature",geometry:{type:"LineString",coordinates:a},properties:{line_name:s.line_name,line_id:s.line_id,color:c,sequence:i}}});this.map.getSource("route").setData({type:"FeatureCollection",features:e})}clearRoute(){this.map.getSource("route").setData({type:"FeatureCollection",features:[]})}updateBranchLines(t){if(t&&t.features){const e=new Set(["bakerloo","central","circle","district","hammersmith-city","jubilee","metropolitan","northern","piccadilly","victoria","waterloo-city","dlr","elizabeth","elizabeth-line"]),s=new Set(["liberty","lioness","mildmay","suffragette","weaver","windrush","london-overground","overground","tram"]);t.features.forEach(i=>{const n=i.properties.line_id;let a=10;e.has(n)?a=30:s.has(n)&&(a=20),i.properties.z_index=a,(i.properties.source_station_id==="940GZZLUADE"||i.properties.target_station_id==="940GZZLUADE")&&console.debug("[DEBUG] BranchLine feature for 940GZZLUADE:",i)})}this.map.getSource("branch-lines").setData(t)}clearBranchLines(){this.map.getSource("branch-lines").setData({type:"FeatureCollection",features:[]})}clearFares(){this.clearBranchLines();const t=this.map.getSource("stations");if(t&&t._data){const e=t._data.features.map(s=>{const i={...s.properties,fare:null,fare_text:"",isOnBranch:!1};return{...s,properties:i}});t.setData({type:"FeatureCollection",features:e})}}clearSelection(){this.originId=null,this.destinationId=null,this.updateStationMarkers(),this.clearRoute(),this.clearBranchLines();const t=this.map.getSource("stations");if(t&&t._data){const e=t._data.features.map(s=>({...s,properties:{...s.properties,fare:null,fare_text:"",isOnBranch:!1,isOrigin:!1,isDestination:!1}}));t.setData({type:"FeatureCollection",features:e})}}on(t,e){this.eventHandlers[t]||(this.eventHandlers[t]=[]),this.eventHandlers[t].push(e)}emit(t,...e){(this.eventHandlers[t]||[]).forEach(i=>i(...e))}}function L(f){return f==null?"—":`£${(f/100).toFixed(2)}`}function B(f){return f==null?"—":`${f.toFixed(1)} km`}class x{constructor(){this.eventHandlers={},this.originInfo=null,this.routesPanel=null,this.destinationInfo=null,this.routeList=null,this.tooltip=null,this.activeRouteId=null}init(){this.originInfo=document.getElementById("origin-info"),this.clearOriginBtn=document.getElementById("clear-origin-btn"),this.routesPanel=document.getElementById("routes-panel"),this.destinationPanel=document.getElementById("destination-panel"),this.destinationInfo=document.getElementById("destination-info"),this.routeList=document.getElementById("route-list"),this.tooltip=document.getElementById("tooltip"),this.setupFilterListeners()}setupFilterListeners(){document.querySelectorAll("[data-sort]").forEach(t=>{t.addEventListener("click",()=>{document.querySelectorAll("[data-sort]").forEach(e=>e.classList.remove("active")),t.classList.add("active"),this.emit("sortChange",t.dataset.sort)})}),document.querySelectorAll("[data-time]").forEach(t=>{t.addEventListener("click",()=>{document.querySelectorAll("[data-time]").forEach(e=>e.classList.remove("active")),t.classList.add("active"),this.emit("timeChange",t.dataset.time)})}),this.clearOriginBtn&&this.clearOriginBtn.addEventListener("click",()=>{this.emit("clearSelection")})}formatLineNames(t){if(!t||t.length===0)return"";const e={"hammersmith-city":"H&C","waterloo-city":"W&C",elizabeth:"Elizabeth",dlr:"DLR"};return t.map(s=>{let i;return e[s]?i=e[s]:i=s.split("-").map(n=>n.charAt(0).toUpperCase()+n.slice(1)).join(" "),`<span class="line-badge line-${s.toLowerCase()}">${i}</span>`}).join("")}setOrigin(t,e){if(!this.originInfo)return;this.clearOriginBtn&&this.clearOriginBtn.classList.remove("hidden");const s=e&&e.length>0?this.formatLineNames(e):t.modes;this.originInfo.innerHTML=`
      <div class="station-name">${t.common_name}</div>
      <div class="station-meta">
        <span class="zone-badge">Zone ${t.zone}</span>
        <span>${s}</span>
      </div>
    `,this.originInfo.classList.add("animate-slide-up"),this.destinationPanel&&this.destinationInfo&&(this.destinationPanel.classList.remove("hidden"),this.destinationInfo.innerHTML='<p class="hint">Click a station on the map</p>')}setDestination(t){this.destinationInfo&&(this.destinationPanel&&this.destinationPanel.classList.remove("hidden"),this.destinationInfo.innerHTML=`
      <div class="station-name">${t.common_name}</div>
      <div class="station-meta">
        <span class="zone-badge">Zone ${t.zone}</span>
      </div>
    `)}showRoutes(t){!this.routesPanel||!this.routeList||(this.routesPanel.classList.remove("hidden"),this.routeList.innerHTML="",t.forEach((e,s)=>{const i=document.createElement("li");i.className="route-item",s===0&&(i.classList.add("active"),this.activeRouteId=e.route_id),i.dataset.routeId=e.route_id;const n=[];e.is_default&&n.push('<span class="route-badge default">Default</span>'),i.innerHTML=`
        <div class="route-header">
          <span class="route-fare">${L(e.fare_pence)}</span>
          <span class="route-distance">${B(e.haversine_distance_km)}</span>
        </div>
        <div class="route-description">
          ${n.join("")}
          ${e.description||"Direct route"}
        </div>
      `,i.addEventListener("click",()=>{this.setActiveRoute(e.route_id),this.emit("routeSelect",e.route_id)}),this.routeList.appendChild(i)}))}setActiveRoute(t){this.activeRouteId=t,document.querySelectorAll(".route-item").forEach(e=>{e.classList.toggle("active",e.dataset.routeId===t)})}showTooltip(t,e,s,i){if(!this.tooltip)return;const n=this.tooltip.querySelector(".tooltip-name"),a=this.tooltip.querySelector(".tooltip-zone"),o=this.tooltip.querySelector(".tooltip-lines"),l=this.tooltip.querySelector(".tooltip-fare.cheapest .fare-value"),c=this.tooltip.querySelector(".tooltip-fare.default .fare-value");if(n&&(n.textContent=t.common_name),a&&(a.textContent=`Zone ${t.zone}`),o&&(i&&i.length>0?(o.innerHTML=this.formatLineNames(i),o.classList.remove("hidden")):(o.innerHTML="",o.classList.add("hidden"))),l&&e&&(l.textContent=L(e.cheapest_offpeak)),c&&e){const F=e.default_fare_offpeak!==null?e.default_fare_offpeak:e.cheapest_offpeak;c.textContent=L(F)}this.tooltip.style.opacity="0",this.tooltip.classList.remove("hidden");const r=this.tooltip.getBoundingClientRect(),d=r.width,p=r.height,u=this.tooltip.parentElement,E=u.offsetWidth,m=u.offsetHeight,y=15,g=10;let _=s.x-d/2;_<g?_=g:_+d>E-g&&(_=E-d-g);let w=s.y-p-y;w<g&&(w=s.y+y,w+p>m-g&&(w=Math.min(w,m-p-g))),this.tooltip.style.transform="none",this.tooltip.style.marginTop="0",this.tooltip.style.left=`${_}px`,this.tooltip.style.top=`${w}px`,requestAnimationFrame(()=>{this.tooltip.style.opacity="1"})}hideTooltip(){this.tooltip&&(this.tooltip.classList.add("hidden"),this.tooltip.style.left="",this.tooltip.style.top="",this.tooltip.style.transform="",this.tooltip.style.marginTop="",this.tooltip.style.opacity="")}updateStats(t){const e=document.getElementById("station-count"),s=document.getElementById("fare-count");e&&(e.textContent=t.stationCount.toLocaleString()),s&&(s.textContent=t.fareCount.toLocaleString())}clearSelection(){this.originInfo&&(this.originInfo.innerHTML='<p class="hint">Click a station on the map</p>'),this.clearOriginBtn&&this.clearOriginBtn.classList.add("hidden"),this.routesPanel&&this.routesPanel.classList.add("hidden"),this.destinationPanel&&this.destinationPanel.classList.add("hidden"),this.routeList&&(this.routeList.innerHTML=""),this.activeRouteId=null}on(t,e){this.eventHandlers[t]||(this.eventHandlers[t]=[]),this.eventHandlers[t].push(e)}emit(t,...e){(this.eventHandlers[t]||[]).forEach(i=>i(...e))}}class P{constructor(t,e){this.nodes=new Map,this.graph=new Map,t.forEach(i=>{this.nodes.set(i.station_id,{id:i.station_id,lat:i.lat,lon:i.lon,name:i.common_name}),this.graph.set(i.station_id,[])}),console.log(`[PathFinder] Indexed ${this.nodes.size} stations.`);let s=0;e.forEach(i=>{let n=i.haversine_distance_km;(typeof n!="number"||isNaN(n))&&(n=this.heuristic(i.source_station_id,i.target_station_id)),isNaN(n)&&(n=.5),i.line_id&&(i.line_id==="PiccDistS2"||i.line_id==="PiccDistS3"||i.line_id==="PiccDistSAC")&&console.log(`[PathFinder] CRITICAL SEGMENT LOADED: ${i.line_id}`,{from:i.source_station_id,to:i.target_station_id,hasCoords:!!i.coordinates}),this.addConnection(i.source_station_id,i.target_station_id,n,i.line_name,i.line_mode,i.coordinates,i.line_id);let a=null;Array.isArray(i.coordinates)&&(a=[...i.coordinates].reverse()),this.addConnection(i.target_station_id,i.source_station_id,n,i.line_name,i.line_mode,a,i.line_id),s+=2}),console.log(`[PathFinder] Graph built with ${s} edges.`)}addConnection(t,e,s,i,n,a,o){this.graph.has(t)||this.graph.set(t,[]);const l=this.graph.get(t);l.some(r=>r.node===e&&r.lineId===o)||l.push({node:e,weight:s,lineName:i,lineId:o,mode:n,coordinates:a})}heuristic(t,e){const s=this.nodes.get(t),i=this.nodes.get(e);if(!s||!i)return 0;const n=6371,a=this.toRad(i.lat-s.lat),o=this.toRad(i.lon-s.lon),l=Math.sin(a/2)*Math.sin(a/2)+Math.cos(this.toRad(s.lat))*Math.cos(this.toRad(i.lat))*Math.sin(o/2)*Math.sin(o/2),c=2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l));return n*c}toRad(t){return t*(Math.PI/180)}findPath(t,e){if(!this.nodes.has(t))return console.error(`[PathFinder] Graph does not contain start node: ${t}`),null;if(!this.nodes.has(e))return console.error(`[PathFinder] Graph does not contain end node: ${e}`),null;const s=[t],i=new Map,n=new Map;n.set(t,0);const a=new Map;a.set(t,this.heuristic(t,e));let o=0;for(;s.length>0;){o++,s.sort((r,d)=>(a.get(r)??1/0)-(a.get(d)??1/0));const l=s.shift();if(l===e)return console.log(`[PathFinder] Target reached in ${o} iterations.`),this.reconstructPath(i,l);const c=this.graph.get(l)||[];for(const r of c){let d=r.weight;(typeof d!="number"||isNaN(d))&&(d=1);const p=(n.get(l)??1/0)+d,u=n.get(r.node)??1/0;p<u&&(i.set(r.node,{from:l,lineName:r.lineName,lineId:r.lineId,weight:d,mode:r.mode,coordinates:r.coordinates}),n.set(r.node,p),a.set(r.node,p+this.heuristic(r.node,e)),s.includes(r.node)||s.push(r.node))}}return console.warn(`[PathFinder] OpenSet empty. Path not found. Iterations: ${o}`),null}reconstructPath(t,e){const s=[];let i=e,n=0;for(;t.has(i);){const a=t.get(i),o=this.nodes.get(a.from),l=this.nodes.get(i);s.unshift({source_station_id:a.from,target_station_id:i,line_name:a.lineName,line_id:a.lineId,line_mode:a.mode,haversine_distance_km:a.weight,coordinates:a.coordinates,source_lat:o?o.lat:0,source_lon:o?o.lon:0,target_lat:l?l.lat:0,target_lon:l?l.lon:0}),n+=a.weight,i=a.from}return{route_id:"calculated_shortest",description:this.generateDescription(s),is_default:!0,haversine_distance_km:n,fare_pence:null,connections:s}}generateDescription(t){if(t.length===0)return"Same station";const e=new Set(t.map(s=>s.line_name));return Array.from(e).join(", ")}}const O={map:{style:"https://tiles.openfreemap.org/styles/liberty",center:[-.118092,51.509865],zoom:11,minZoom:9,maxZoom:16},data:{basePath:"/faremap/data",files:{stations:"stations.parquet",fares:"fares.parquet",routes:"routes.parquet",connections:"connections.parquet"}}};class H{constructor(){this.db=null,this.map=null,this.ui=null,this.pathFinder=null,this.selectedOrigin=null,this.selectedDestination=null,this.sortMode="default",this.timeMode="offpeak",this.maxFare=1e5}async init(){try{this.updateLoadingText("Initializing DuckDB-WASM..."),this.db=new $,await this.db.init(),this.updateLoadingText("Loading data files..."),await this.db.loadParquetFiles(O.data.basePath,O.data.files),this.updateLoadingText("Initializing map..."),this.map=new k("map",O.map),await this.map.init(),this.ui=new x,this.ui.init();const t=await this.db.getAllStations();this.map.addStations(t);const e=await this.db.getAllConnections();console.log(`[App] Loaded ${e.length} connections for PathFinder.`),this.pathFinder=new P(t,e);const s=await this.db.getStats();this.ui.updateStats(s),this.setupEventHandlers(),this.showApp(),console.info("FareMap initialized successfully")}catch(t){console.error("Failed to initialize FareMap:",t),this.showError(t.message)}}setupEventHandlers(){this.map.on("stationClick",async t=>{await this.handleStationClick(t)}),this.map.on("stationHover",async(t,e)=>{this.selectedOrigin&&t!==this.selectedOrigin&&await this.handleStationHover(t,e)}),this.map.on("stationHoverEnd",()=>{this.ui.hideTooltip()}),this.ui.on("routeSelect",async t=>{if(t==="calculated_shortest"){const e=this.pathFinder.findPath(this.selectedOrigin,this.selectedDestination);await this.handleRouteSelect(t,e)}else await this.handleRouteSelect(t)}),this.ui.on("sortChange",async t=>{this.sortMode=t,await this.refreshFareVisualization()}),this.ui.on("timeChange",async t=>{this.timeMode=t,await this.refreshFareVisualization()}),this.ui.on("clearSelection",()=>{this.clearSelection()})}async handleStationClick(t){if(this.selectedOrigin)if(t===this.selectedOrigin)this.clearSelection();else{this.selectedDestination=t;const e=await this.db.getStation(t);let i=[...await this.db.getRouteOptions(this.selectedOrigin,t,this.timeMode)];if(this.pathFinder){console.log(`[App] calculating shortest path from ${this.selectedOrigin} to ${t}`);const n=this.pathFinder.findPath(this.selectedOrigin,t);n?(console.log("[App] Shortest path found:",n),n.description=`⚡ ${n.description}`,i.unshift(n)):console.warn("[App] No shortest path found via A*")}this.ui.setDestination(e),this.ui.showRoutes(i),this.map.setDestination(t),i.length>0&&await this.handleRouteSelect(i[0].route_id,i[0]),await this.refreshFareVisualization()}else{this.selectedOrigin=t;const e=await this.db.getStation(t),s=await this.db.getLinesAtStation(t);this.ui.setOrigin(e,s),this.map.setOrigin(t),await this.refreshFareVisualization()}}async handleStationHover(t,e){const s=await this.db.getStation(t),i=await this.db.getFareSummary(this.selectedOrigin,t),n=await this.db.getLinesAtStation(t);this.ui.showTooltip(s,i,e,n)}async handleRouteSelect(t,e){console.log(`[App] handleRouteSelect executing for routeId: ${t}`);let s;t==="calculated_shortest"&&e?s=e.connections:s=await this.db.getRouteConnections(t),(!s||s.length===0)&&console.warn("[App] No connections found for route!"),this.map.drawRoute(s),this.ui.setActiveRoute(t)}async refreshFareVisualization(){if(!this.selectedOrigin)return;if(this.selectedDestination){this.map.clearBranchLines();const n=this.pathFinder.findPath(this.selectedOrigin,this.selectedDestination),a=new Set;a.add(this.selectedDestination),n&&n.connections&&n.connections.forEach(c=>{a.add(c.source_station_id),a.add(c.target_station_id)});const l=(await this.db.getFaresFromOrigin(this.selectedOrigin,this.sortMode,this.timeMode,this.maxFare)).filter(c=>a.has(c.dest_id));this.map.updateFareHeatmap(l,a,this.timeMode);return}const t=await this.db.getFaresFromOrigin(this.selectedOrigin,this.sortMode,this.timeMode,this.maxFare),e=await this.db.getLinesAtStation(this.selectedOrigin),s=await this.db.getStationsOnLines(e),i=await this.db.getRouteGeometry(e);this.map.updateBranchLines(i),this.map.updateFareHeatmap(t,s,this.timeMode)}clearSelection(){this.selectedOrigin=null,this.selectedDestination=null,this.ui.clearSelection(),this.map.clearSelection()}updateLoadingText(t){const e=document.querySelector(".loading-text");e&&(e.textContent=t)}showApp(){const t=document.getElementById("loading-screen"),e=document.getElementById("app");t&&t.classList.add("hidden"),e&&e.classList.remove("hidden")}showError(t){const e=document.querySelector(".loading-text");e&&(e.textContent=`Error: ${t}`,e.style.color="var(--accent-error)")}}document.addEventListener("DOMContentLoaded",()=>{new H().init()});
